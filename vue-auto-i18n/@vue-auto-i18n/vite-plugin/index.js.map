{"version":3,"sources":["../src/index.ts","../src/transform.ts","../src/cache.ts"],"sourcesContent":["/**\r\n * @vue-auto-i18n/vite-plugin\r\n * Vite plugin for automatic i18n transformation\r\n */\r\n\r\nimport { readFileSync } from 'fs'\r\nimport { join } from 'path'\r\nimport type { Plugin } from 'vite'\r\nimport { transform } from './transform.js'\r\nimport { createCacheManager } from './cache.js'\r\n\r\nexport interface PluginOptions {\r\n  localesDir?: string\r\n  cacheDir?: string\r\n  devMode?: boolean\r\n  injectI18n?: boolean\r\n  transformMode?: 'replace' | 'inject'\r\n}\r\n\r\n/**\r\n * Create Vite Auto I18n Plugin\r\n */\r\nexport function createAutoI18nPlugin(options: PluginOptions = {}): Plugin {\r\n  const {\r\n    localesDir = 'src/locales',\r\n    cacheDir = '.i18n-cache',\r\n    devMode = false,\r\n    injectI18n = true,\r\n    transformMode = 'replace'\r\n  } = options\r\n\r\n  // Store language pack mapping\r\n  let keyMap: Record<string, string> | null = null\r\n  let isProduction = false\r\n  const cacheManager = createCacheManager(cacheDir)\r\n\r\n  return {\r\n    name: 'vite-plugin-auto-i18n',\r\n    enforce: 'pre', // Âú® Vue Êèí‰ª∂‰πãÂâçÊâßË°åÔºåÁ°Æ‰øùËÉΩÊãøÂà∞ÂéüÂßã .vue Êñá‰ª∂\r\n\r\n    // Detect production mode\r\n    config(config, { command }) {\r\n      isProduction = command === 'build'\r\n    },\r\n\r\n    // Load language pack at build start\r\n    buildStart() {\r\n      // Clear cache to ensure fresh transformation\r\n      cacheManager.clear()\r\n\r\n      try {\r\n        const zhPath = join(process.cwd(), localesDir, 'zh-CN.json')\r\n        const content = readFileSync(zhPath, 'utf-8')\r\n        keyMap = JSON.parse(content)\r\n\r\n        if (!devMode) {\r\n          console.log('\\nüåç [vite-plugin-auto-i18n] Language pack loaded')\r\n          console.log(`   - Keys count: ${Object.keys(keyMap || {}).length}`)\r\n          console.log(`   - Mode: ${isProduction ? 'production' : 'development'}`)\r\n        }\r\n      } catch (error) {\r\n        console.warn('[vite-plugin-auto-i18n] Language pack not found, skipping transformation')\r\n        keyMap = null\r\n      }\r\n    },\r\n\r\n    // Transform code\r\n    transform(code, id) {\r\n      // Skip in dev mode unless enabled\r\n      if (!devMode && !isProduction) {\r\n        return null\r\n      }\r\n\r\n      // Skip if no language pack\r\n      if (!keyMap) {\r\n        return null\r\n      }\r\n\r\n      // Only process .vue, .js, .ts files\r\n      if (!/\\.(vue|js|ts|jsx|tsx)$/.test(id)) {\r\n        return null\r\n      }\r\n\r\n      // Skip node_modules\r\n      if (id.includes('node_modules')) {\r\n        return null\r\n      }\r\n\r\n      // Log that we're processing this file\r\n      if (!devMode) {\r\n        console.log(`[vite-plugin-auto-i18n] Processing: ${id.split('/').pop()}`)\r\n      }\r\n\r\n      // Check cache\r\n      const cached = cacheManager.get(id, code)\r\n      if (cached) {\r\n        if (!devMode) {\r\n          console.log(`[vite-plugin-auto-i18n] Using cached result`)\r\n        }\r\n        return cached\r\n      }\r\n\r\n      // Perform transformation\r\n      const result = transform(code, id, keyMap, transformMode)\r\n\r\n      // Log result\r\n      if (!devMode) {\r\n        if (result && result.code !== code) {\r\n          console.log(`[vite-plugin-auto-i18n] ‚úì Transformed: ${id.split('/').pop()}`)\r\n        } else if (result) {\r\n          console.log(`[vite-plugin-auto-i18n] - No changes needed`)\r\n        } else {\r\n          console.log(`[vite-plugin-auto-i18n] - Skipped (no transformation)`)\r\n        }\r\n      }\r\n\r\n      // Cache result\r\n      if (result) {\r\n        cacheManager.set(id, code, result)\r\n      }\r\n\r\n      return result\r\n    },\r\n\r\n    // Handle HTML (optional)\r\n    transformIndexHtml: {\r\n      order: 'post',\r\n      handler(html) {\r\n        if (!injectI18n || !keyMap) return html\r\n        return html\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport default createAutoI18nPlugin\r\n","/**\r\n * AST Transformation Logic\r\n * Uses simple text replacement instead of AST manipulation to avoid conflicts with Vue plugin\r\n */\r\n\r\nexport function transform(\r\n  code: string,\r\n  id: string,\r\n  keyMap: Record<string, string>,\r\n  mode: string = 'replace'\r\n): { code: string; map: null } | null {\r\n  // Only handle .vue files\r\n  if (!id.endsWith('.vue')) {\r\n    return null\r\n  }\r\n\r\n  // Skip if not a complete Vue file (must have <template> tag)\r\n  if (!code.includes('<template')) {\r\n    return null\r\n  }\r\n\r\n  // Skip if code is already transformed (contains $t)\r\n  if (code.includes('{{ $t') || code.includes('{{$t')) {\r\n    return null\r\n  }\r\n\r\n  console.log(`[vite-plugin-auto-i18n] Processing: ${id.split('/').pop()}`)\r\n\r\n  try {\r\n    // Simple approach: replace Chinese text in template with {{ $t('key') }}\r\n    let transformedCode = code\r\n    let hasChanges = false\r\n\r\n    // Extract template section\r\n    const templateMatch = code.match(/<template[^>]*>([\\s\\S]*?)<\\/template>/)\r\n    if (!templateMatch) {\r\n      return null\r\n    }\r\n\r\n    let template = templateMatch[1]\r\n\r\n    // Replace Chinese text outside of existing interpolations\r\n    // Pattern: Match text that's not inside {{ }} and contains Chinese characters\r\n    const chinesePattern = />([^<{]*)</g\r\n\r\n    template = template.replace(chinesePattern, (match, text) => {\r\n      const trimmed = text.trim()\r\n      if (!trimmed || trimmed.length === 0) {\r\n        return match\r\n      }\r\n\r\n      // Check if this text matches any key in keyMap\r\n      for (const [key, value] of Object.entries(keyMap)) {\r\n        if (value === trimmed) {\r\n          hasChanges = true\r\n          return `>{{ $t('${key}') }}<`\r\n        }\r\n      }\r\n\r\n      return match\r\n    })\r\n\r\n    // Also handle attributes with Chinese values\r\n    // Match: attr=\"‰∏≠Êñá\" or attr='‰∏≠Êñá'\r\n    const attrPattern = /(\\s+)([\\w-]+)=[\"']([^\"']*[\\u4e00-\\u9fa5]+[^\"']*)[\"']/g\r\n\r\n    template = template.replace(attrPattern, (match, space, attrName, attrValue) => {\r\n      const trimmed = attrValue.trim()\r\n      if (!trimmed) {\r\n        return match\r\n      }\r\n\r\n      // Check if this value matches any key in keyMap\r\n      for (const [key, value] of Object.entries(keyMap)) {\r\n        if (value === trimmed) {\r\n          hasChanges = true\r\n          return `${space}${attrName}=\"{{ $t('${key}') }}\"`\r\n        }\r\n      }\r\n\r\n      return match\r\n    })\r\n\r\n    if (hasChanges) {\r\n      // Replace template in original code\r\n      transformedCode = code.replace(\r\n        /<template[^>]*>[\\s\\S]*?<\\/template>/,\r\n        `<template>${template}</template>`\r\n      )\r\n\r\n      console.log(`[vite-plugin-auto-i18n] ‚úì Transformed: ${id.split('/').pop()}`)\r\n\r\n      return {\r\n        code: transformedCode,\r\n        map: null\r\n      }\r\n    }\r\n\r\n    console.log(`[vite-plugin-auto-i18n] - No Chinese text found`)\r\n    return null\r\n\r\n  } catch (error: any) {\r\n    console.error(`[vite-plugin-auto-i18n] Error transforming ${id}:`, error.message)\r\n    return null\r\n  }\r\n}\r\n","/**\r\n * Cache Manager for Incremental Builds\r\n */\r\n\r\nimport { promises as fs } from 'fs'\r\nimport { createHash } from 'crypto'\r\nimport path from 'path'\r\n\r\nexport interface CacheEntry {\r\n  code: string\r\n  timestamp: number\r\n}\r\n\r\nexport interface CacheManager {\r\n  get(id: string, code: string): { code: string; map: null } | null\r\n  set(id: string, originalCode: string, result: { code: string; map: null }): void\r\n  clear(): Promise<void>\r\n}\r\n\r\n/**\r\n * Create cache manager\r\n */\r\nexport function createCacheManager(cacheDir: string): CacheManager {\r\n  const cachePath = path.join(process.cwd(), cacheDir, 'vite-plugin-cache.json')\r\n  let cache: Map<string, CacheEntry> = new Map()\r\n\r\n  // Load cache from disk\r\n  async function loadCache() {\r\n    try {\r\n      const content = await fs.readFile(cachePath, 'utf-8')\r\n      const data = JSON.parse(content)\r\n      cache = new Map(Object.entries(data))\r\n    } catch {\r\n      // Cache file doesn't exist or is invalid\r\n      cache = new Map()\r\n    }\r\n  }\r\n\r\n  // Save cache to disk\r\n  async function saveCache() {\r\n    try {\r\n      const data = Object.fromEntries(cache)\r\n      await fs.mkdir(path.dirname(cachePath), { recursive: true })\r\n      await fs.writeFile(cachePath, JSON.stringify(data), 'utf-8')\r\n    } catch (error) {\r\n      console.warn('Failed to save cache:', error)\r\n    }\r\n  }\r\n\r\n  // Initialize cache\r\n  loadCache()\r\n\r\n  return {\r\n    get(id: string, code: string): { code: string; map: null } | null {\r\n      const hash = createHash('md5').update(code).digest('hex')\r\n      const key = `${id}:${hash}`\r\n      const entry = cache.get(key)\r\n\r\n      if (entry) {\r\n        return {\r\n          code: entry.code,\r\n          map: null\r\n        }\r\n      }\r\n\r\n      return null\r\n    },\r\n\r\n    set(id: string, originalCode: string, result: { code: string; map: null }): void {\r\n      const hash = createHash('md5').update(originalCode).digest('hex')\r\n      const key = `${id}:${hash}`\r\n      const entry: CacheEntry = {\r\n        code: result.code,\r\n        timestamp: Date.now()\r\n      }\r\n      cache.set(key, entry)\r\n      saveCache()\r\n    },\r\n\r\n    async clear(): Promise<void> {\r\n      cache.clear()\r\n      try {\r\n        await fs.unlink(cachePath)\r\n      } catch {\r\n        // File doesn't exist\r\n      }\r\n    }\r\n  }\r\n}\r\n"],"mappings":"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","names":[]}